> ðŸ›  **Status: Maintenance Mode | Stable**
>
> This project is currently in [maintenance mode](https://en.wikipedia.org/wiki/Maintenance_mode) - users should feel free to continue to use this app and expect bug fixes, but not expect many additional features.

# Resonate Track Server API

The track-server-api delivers streaming track downloads, and accepts track uploads.
It's still WIP.
It uses [Twirp](https://github.com/twitchtv/twirp), a RPC framework for service-to-service communication emphasizing simplicity and minimalism. Learn more about
Twirp at its [website](https://twitchtv.github.io/twirp/docs/intro.html).
It also uses [go-pg](https://github.com/go-pg/pg) PostgreSQL ORM.
Its structure is based on the Twirp starter kit [Twisk](https://github.com/ribice/twisk).

## Table of Contents
- [Project Structure](#project-structure)
- [Getting started](#getting-started)
    - [Prerequisites](#prerequisites)
    - [Dev database setup](#dev-database-setup)
    - [Dependencies](#dependencies)
    - [Tools](#tools)
    - [Running the server](#running-the-server)
    - [Implementing new services](#implementing-new-services)
- [Documentation](#documentation)
- [Testing](#testing)
- [Roadmap](#roadmap)
- [Contributing](#contributing)

## Project Structure

The project structure mostly follows [THIS](https://github.com/golang-standards/project-layout) example repository and [Twirp best practices](https://twitchtv.github.io/twirp/docs/best_practices.html), except for the main service that lives in `internal/server/`.

## Getting started

### Prerequisites
- [Go](https://golang.org/) 1.7 or higher.
- [PostgreSQL](https://www.postgresql.org/) 9.4 or higher.
- [FFmpeg](https://ffmpeg.org/) latest.

### Dev database setup

* Create user and database as follow (as found in the local config file in `./conf.local.yaml`):

username = "track_resonate_dev_user"

password = "password"

dbname = "track_resonate_dev"

Add following postgres extension: "uuid-ossp"

From `./cmd/migration`:

* Init migrations

```sh
$ go run *.go init
```

* Run migrations

```sh
$ go run *.go
```

### Dependencies

[Dep](https://github.com/golang/dep) is used as dependency management tool.
`vendor/` folder contains project dependencies and should be in sync with `Gopkg.toml` and `Gopkg.lock`.

### Tools

* [Install Protocol Buffers v3](https://developers.google.com/protocol-buffers/docs/gotutorial),
the `protoc` compiler that is used to auto-generate code. The simplest way to do
this is to download pre-compiled binaries for your platform from here:
https://github.com/google/protobuf/releases

It is also available in MacOS through Homebrew:

```sh
$ brew install protobuf
```

* Install [retool](https://github.com/twitchtv/retool). It helps manage go tools like commands and linters.
protoc-gen-go and protoc-gen-twirp plugins were installed into `_tools` folder using retool.

Build the generators and tool dependencies:
```sh
$ retool build
```

Then, to run the `protoc` command and autogenerate Go code for the server interface, make sure to prefix with `retool do`, for example:
```sh
$ retool do protoc --proto_path=$GOPATH/src:. --twirp_out=. --go_out=. ./rpc/user/service.proto
```

### Running the server

First, put this repo into `$GOPATH/src`

Then, run the server
```sh
$ go run ./cmd/api/main.go
```

Alternatively, you can build and run an executable binary
```sh
$ cd ./cmd/api/
$ go build
$ ./api
```

## Documentation

- There is no API documentation yet, except for this README. Eventually, documentation will be provided in `doc/api` using [OpenAPI Specification and Swagger](https://swagger.io/docs/specification/about/).

- TODO: `doc/database` contains autogenerated database documentation, using [SchemaSpy](http://schemaspy.org/). Open `doc/database/index.html` in your browser to check it out.

## Testing

We use [Ginkgo](https://onsi.github.io/ginkgo/) and [Gomega](https://onsi.github.io/gomega/) for testing.

You need to create the testing database and run migrations manually before running tests.

* Create user and database as follow:

username = "track_resonate_testing_user"

password = ""

dbname = "track_resonate_testing"

Add following extension: "uuid-ossp"

* Run migrations from `./cmd/migration`

```sh
$ go run *.go init testing
$ go run *.go testing
```

* Run tests `./internal/server/`

```sh
$ go test
```

Or run all tests using ginkgo CLI from `./`

```sh
$ ginkgo -r
```

## Roadmap

- The service that is currently implemented is based on an experimental [Twirp v6_streams_alpha branch](https://github.com/twitchtv/twirp/tree/v6_streams_alpha). Adding streaming support to Twirp is still [being discussed](https://github.com/twitchtv/twirp/issues/70) within the community. Given the [recent discussions](https://github.com/twitchtv/twirp/issues/70#issuecomment-470367807), we might need to find another way to implement it.
- Write documentation with OpenAPI and autogenerated API documentation using SwaggerUI
- TBC

## Contributing

Please check out the [Contributing guide](CONTRIBUTING.md) for guidelines about how to proceed.

We expect contributors to abide by our underlying [code of conduct](CODE_OF_CONDUCT.md).
